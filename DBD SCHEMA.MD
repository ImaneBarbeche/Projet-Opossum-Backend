# ğŸ—„ï¸ OPOSSUM Database Schema - Version MVP

## ğŸ“Š Database Overview

**Database:** `opossum_db` (PostgreSQL)  
**Architecture:** Monolithic - Single database  
**Version:** MVP (Minimum Viable Product)  
**Tables:** 6 tables essentielles seulement

---

## ğŸ‘¤ Table: `users`

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **email** | varchar(255) | Unique, Not null |
| **password_hash** | varchar(255) | Not null, Hashed with bcrypt |
| **first_name** | varchar(100) | Not null, length: 2<N<50 |
| **last_name** | varchar(100) | Not null, length: 2<N<50 |
| **phone** | varchar(20) | Nullable, French format |
| **avatar_url** | varchar(500) | Nullable, Direct URL |
| **role** | varchar(20) | Not null, Default: 'USER', Enum: USER/ADMIN |
| **is_active** | boolean | Default: true |
| **is_email_verified** | boolean | Default: false |
| **email_verification_token** | varchar(255) | Nullable |
| **password_reset_token** | varchar(255) | Nullable |
| **password_reset_expires_at** | timestamp | Nullable |
| **created_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |
| **updated_at** | timestamp | Default: CURRENT_TIMESTAMP, Auto-update |
| **last_login_at** | timestamp | Nullable |

### ğŸ”‘ Key Details
- **Primary Key:** id (UUID)
- **Authentication:** Email/password with JWT
- **Avatar:** Simple URL string (pas de table files complexe)
- **Verification:** Email verification token
- **Admin:** Role-based access for moderation

---

## ğŸ”„ Table: `refresh_tokens`

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **user_id** | UUID | Not null, FK â†’ users(id), CASCADE |
| **token** | varchar(255) | Unique, Not null |
| **expires_at** | timestamp | Not null |
| **created_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |
| **is_revoked** | boolean | Default: false |

### ğŸ”‘ Key Details
- **Purpose:** JWT refresh mechanism as required by brief
- **Security:** Token revocation support
- **Expiration:** 7 days default

---

## ğŸ“£ Table: `annonces`

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **title** | varchar(200) | Not null, length: 5<N<200 |
| **description** | text | Not null, length: 10<N<2000 |
| **type** | varchar(10) | Not null, Enum: LOST/FOUND |
| **category** | varchar(50) | Not null |
| **status** | varchar(20) | Default: 'ACTIVE', Enum: ACTIVE/RESOLVED/ARCHIVED/DELETED |
| **latitude** | decimal(10,8) | Not null, Range: -90 to 90 |
| **longitude** | decimal(11,8) | Not null, Range: -180 to 180 |
| **address** | text | Nullable |
| **city** | varchar(100) | Not null |
| **photo_url** | varchar(500) | Nullable, **UNE SEULE PHOTO** |
| **contact_phone** | varchar(20) | Nullable |
| **contact_email** | varchar(255) | Nullable |
| **user_id** | UUID | Not null, FK â†’ users(id), CASCADE |
| **created_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |
| **updated_at** | timestamp | Default: CURRENT_TIMESTAMP, Auto-update |
| **resolved_at** | timestamp | Nullable |

### ğŸ”‘ Key Details
- **Primary Key:** id (UUID)
- **Geolocation:** Latitude/longitude as required
- **Photo:** Simple URL field (une seule photo pour MVP)
- **Status:** Lifecycle management
- **Contact:** Optional contact info
- **Moderation:** Admins can update status to ARCHIVED/DELETED

---

## ğŸ“ Table: `files` (Optionnelle pour MVP)

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **original_name** | varchar(255) | Not null |
| **stored_name** | varchar(255) | Not null, Unique generated name |
| **file_path** | varchar(500) | Not null, Relative path |
| **mime_type** | varchar(100) | Not null |
| **file_size** | integer | Not null, Max: 10MB |
| **uploaded_by** | UUID | Not null, FK â†’ users(id), CASCADE |
| **is_deleted** | boolean | Default: false |
| **created_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |

### ğŸ”‘ Key Details
- **Purpose:** File upload as required by brief
- **Simplification:** Pas de mÃ©tadonnÃ©es complexes pour MVP
- **Usage:** URL retournÃ©e et stockÃ©e dans annonces.photo_url

---

## ğŸ’¬ Table: `conversations`

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **annonce_id** | UUID | Not null, FK â†’ annonces(id), CASCADE |
| **user1_id** | UUID | Not null, FK â†’ users(id), CASCADE |
| **user2_id** | UUID | Not null, FK â†’ users(id), CASCADE |
| **created_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |
| **updated_at** | timestamp | Default: CURRENT_TIMESTAMP, Auto-update |

### ğŸ”‘ Key Details
- **Purpose:** "Discussions 1-1 entre utilisateurs" comme demandÃ©
- **Participants:** user1 = owner annonce, user2 = interested party
- **Constraint:** UNIQUE(annonce_id, user1_id, user2_id)

---

## ğŸ’¬ Table: `messages`

| Key | Type | Options |
|-----|------|---------|
| **id** | UUID | Primary Key, Default: gen_random_uuid() |
| **conversation_id** | UUID | Not null, FK â†’ conversations(id), CASCADE |
| **sender_id** | UUID | Not null, FK â†’ users(id), CASCADE |
| **content** | text | Not null |
| **is_read** | boolean | Default: false |
| **sent_at** | timestamp | Not null, Default: CURRENT_TIMESTAMP |

### ğŸ”‘ Key Details
- **Purpose:** "Historique par annonce" comme demandÃ©
- **Content:** Text messages only for MVP
- **Read Status:** Basic unread tracking

---

## ğŸš€ Ce qui est **SUPPRIMÃ‰** pour MVP :

### âŒ **Tables supprimÃ©es :**
- **`annonce_photos`** - Trop complexe, une seule photo suffit
- **`reports`** - Pas dans le brief initial
- **MÃ©tadonnÃ©es avancÃ©es** dans files (width, height, etc.)

### âŒ **FonctionnalitÃ©s simplifiÃ©es :**
- **Photos multiples** â†’ Une seule photo par annonce
- **Signalements** â†’ Phase 3 (si temps)
- **ModÃ©ration avancÃ©e** â†’ Simple changement de statut par admin
- **Chiffrement messages** â†’ Phase 3 (si temps)

---

## âœ… **Ce qui respecte EXACTEMENT le brief :**

### **FonctionnalitÃ©s utilisateur :**
- âœ… Authentification (JWT + refresh)
- âœ… Annonces CRUD avec gÃ©oloc
- âœ… Une photo par annonce
- âœ… Messagerie 1-1
- âœ… Filtrage et recherche

### **FonctionnalitÃ©s admin :**
- âœ… Statistiques (via queries)
- âœ… Gestion utilisateurs (bloquer = is_active = false)
- âœ… ModÃ©ration annonces (changer status)

---

## ğŸ“Š Relations simplifiÃ©es :

```
users (1) â†â†’ (N) annonces
users (1) â†â†’ (N) refresh_tokens
users (1) â†â†’ (N) conversations (as user1_id/user2_id)
users (1) â†â†’ (N) messages
users (1) â†â†’ (N) files

annonces (1) â†â†’ (N) conversations
conversations (1) â†â†’ (N) messages
```

---

## ğŸ¯ **Avantages de cette approche MVP :**

- âœ… **6 tables seulement** au lieu de 8
- âœ… **Respecte 100% le brief**
- âœ… **DÃ©veloppement plus rapide**
- âœ… **Moins de complexitÃ©**
- âœ… **Fonctionnel pour la dÃ©monstration**
- âœ… **Extensible** si besoin plus tard

---

## ğŸ“ **Note importante :**
Cette version MVP couvre **TOUTES** les fonctionnalitÃ©s demandÃ©es dans le brief, mais de maniÃ¨re simplifiÃ©e. Vous pouvez toujours ajouter des tables comme `annonce_photos` ou `reports` en Phase 2/3 si vous avez le temps ! ğŸš€
